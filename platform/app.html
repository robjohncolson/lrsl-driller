<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driller - AP Statistics Practice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .streak-pulse { animation: pulse 0.5s ease-in-out; }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    .feedback-card { transition: all 0.3s ease-out; }
    .katex-like { font-family: "Times New Roman", serif; font-style: italic; }
    @keyframes flash {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @keyframes slide-in {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .animate-slide-in { animation: slide-in 0.3s ease-out; }
    .star-gold { color: #fbbf24; }
    .star-silver { color: #9ca3af; }
    .star-bronze { color: #d97706; }
    .star-tin { color: #6b7280; }
    .feedback-E { background-color: #dcfce7; border-color: #22c55e; }
    .feedback-P { background-color: #fef9c3; border-color: #eab308; }
    .feedback-I { background-color: #fee2e2; border-color: #ef4444; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-2 flex items-center justify-between">
      <!-- Left: Title + Topic Select -->
      <div class="flex items-center gap-3">
        <h1 id="app-title" class="text-lg font-bold text-purple-700">Driller</h1>
        <select id="cartridge-select" class="text-sm border border-gray-300 rounded px-2 py-1 focus:border-purple-500 bg-white">
          <option value="lsrl-interpretation">LSRL Interpretation</option>
          <option value="residuals">Residuals</option>
        </select>
      </div>

      <!-- Center: Stars + Rank (main progress indicators) -->
      <div class="flex items-center gap-3">
        <!-- Compact Star Counts -->
        <div class="flex items-center gap-1 text-xs bg-gray-50 rounded-lg px-2 py-1">
          <span class="star-gold" title="Gold">‚òÖ</span><span id="gold-count" class="font-bold text-yellow-600 mr-1">0</span>
          <span class="star-silver" title="Silver">‚òÖ</span><span id="silver-count" class="font-bold text-gray-500 mr-1">0</span>
          <span class="star-bronze" title="Bronze">‚òÖ</span><span id="bronze-count" class="font-bold text-amber-700 mr-1">0</span>
          <span class="star-tin" title="Tin">‚òÖ</span><span id="tin-count" class="font-bold text-stone-500">0</span>
        </div>

        <!-- Compact Rank -->
        <div id="rank-display" class="flex items-center gap-1.5 bg-gray-50 rounded-lg px-2 py-1" title="Your rank">
          <span id="rank-icon" class="text-base">üìä</span>
          <span id="rank-name" class="text-xs font-semibold text-gray-700">Novice</span>
          <div class="w-12 h-1 bg-gray-200 rounded-full overflow-hidden">
            <div id="rank-progress-bar" class="h-full bg-purple-500 transition-all duration-500" style="width: 0%"></div>
          </div>
          <span id="rank-points" class="text-xs text-gray-400">0</span>
        </div>

        <!-- Hidden streaks container (still updated by JS) -->
        <div id="streaks-display" class="hidden"></div>
      </div>

      <!-- Right: User + Actions -->
      <div class="flex items-center gap-2">
        <!-- Teacher Controls (hidden by default) -->
        <button id="teacher-review-btn" style="display: none;" class="relative p-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg transition-colors" title="Student Reviews">
          <span class="text-base">üìù</span>
          <span id="header-review-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-4 h-4 rounded-full flex items-center justify-center" style="display: none;">0</span>
        </button>
        <button id="class-time-btn" style="display: none;" class="p-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors" title="Class Time">
          <span class="text-base">üîî</span>
        </button>

        <!-- Online Indicator (compact) -->
        <div id="online-indicator" class="relative">
          <button id="online-btn" class="flex items-center gap-1 px-2 py-1 hover:bg-gray-100 rounded-lg transition-colors" title="Online users">
            <span id="connection-dot" class="w-2 h-2 bg-gray-400 rounded-full"></span>
            <span id="online-count" class="text-xs font-medium text-gray-600">0</span>
          </button>
          <div id="online-dropdown" class="absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-50 hidden">
            <div class="px-3 py-1 text-xs font-medium text-gray-500 uppercase tracking-wide border-b border-gray-100 mb-1">Online Now</div>
            <div id="online-list" class="max-h-48 overflow-y-auto"></div>
          </div>
        </div>

        <!-- Leaderboard (icon only) -->
        <button id="leaderboard-btn" class="p-1.5 hover:bg-yellow-100 text-yellow-600 rounded-lg transition-colors" title="Leaderboard">
          <span class="text-base">üèÜ</span>
        </button>

        <!-- User Display -->
        <div id="user-display" class="flex items-center gap-1.5 bg-gray-50 rounded-full px-2 py-1 cursor-pointer hover:bg-gray-100 transition-colors" title="Click to change username">
          <span id="user-status-dot" class="w-2 h-2 bg-green-400 rounded-full"></span>
          <span id="current-username" class="text-xs font-medium text-gray-700 max-w-[80px] truncate">...</span>
          <span id="teacher-badge" class="hidden text-xs bg-purple-600 text-white px-1 py-0.5 rounded text-[10px]">T</span>
        </div>

        <!-- Settings -->
        <button id="settings-btn" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors" title="Settings">
          <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Class Time Banner (hidden by default) -->
  <div id="class-time-banner" class="hidden bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 text-white py-2 px-4 shadow-lg">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl animate-pulse">üîî</span>
        <div>
          <span class="font-bold">CLASS TIME ACTIVE</span>
          <span id="class-time-timer" class="ml-2 font-mono bg-white/20 px-2 py-0.5 rounded">00:00</span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <span class="text-sm">Goal:</span>
          <div class="w-32 h-4 bg-white/30 rounded-full overflow-hidden">
            <div id="class-goal-bar" class="h-full bg-yellow-400 transition-all duration-500" style="width: 0%"></div>
          </div>
          <span class="text-sm font-bold">
            <span id="class-stars-earned">0</span>/<span id="class-goal-target">3</span> ‚≠ê
          </span>
        </div>
        <button id="end-class-time-btn" class="hidden bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors">
          End Class
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content - Split Pane Layout -->
  <main id="main-content" class="max-w-6xl mx-auto px-4 h-[calc(100vh-48px)] flex flex-col lg:flex-row gap-4 py-4 overflow-hidden">
    <!-- Left Pane: Question (fixed, never scrolls) -->
    <div id="left-pane" class="lg:w-1/2 flex-shrink-0 flex flex-col gap-3 max-h-[45vh] lg:max-h-full overflow-hidden">
      <!-- Scenario Card -->
      <div id="scenario-card" class="bg-white rounded-xl shadow-lg p-4 flex-shrink-0">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs text-gray-500 uppercase tracking-wide">Scenario:</span>
          <h2 id="scenario-title" class="text-base font-semibold text-gray-800"></h2>
        </div>
        <p id="scenario-text" class="text-sm text-gray-600 mb-3"></p>

        <!-- Info Panel -->
        <div id="info-panel" class="flex flex-wrap gap-2 text-sm"></div>
      </div>

      <!-- Graph Container - flex-1 to fill remaining space -->
      <div id="graph-card" class="bg-white rounded-xl shadow-lg p-4 flex-1 min-h-0 flex flex-col">
        <div id="graph-container" class="w-full flex-1 min-h-[150px] bg-gray-50 rounded-lg"></div>
      </div>
    </div>

    <!-- Right Pane: Answers (scrollable) -->
    <div id="right-pane" class="lg:w-1/2 flex-1 overflow-y-auto space-y-4 pr-1">
        <!-- Mode Tabs -->
        <div id="mode-tabs" class="flex gap-2 flex-wrap"></div>

        <!-- Input Cards -->
        <div id="input-container" class="space-y-4"></div>

        <!-- Action Buttons -->
        <div class="flex gap-3 flex-wrap">
          <button id="btn-grade" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg shadow-lg transition-all transform hover:scale-[1.02]">
            Grade My Answer
          </button>
          <button id="btn-try-again" class="hidden flex-1 bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-lg shadow-lg transition-all">
            Try Again
          </button>
          <button id="btn-next" class="hidden flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg shadow-lg transition-all transform hover:scale-[1.02]">
            Next ‚Üí
          </button>
          <button id="btn-teacher-review" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-3 rounded-lg shadow-lg transition-all flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            Request Teacher Review
          </button>
          <button id="btn-skip" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold px-6 py-3 rounded-lg shadow transition-all">
            Skip
          </button>
        </div>

        <!-- AI Toggle & Hint Status -->
        <div class="flex justify-center items-center gap-4 text-sm">
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-500">Keywords</span>
            <button id="ai-toggle" class="relative inline-flex h-5 w-9 items-center rounded-full bg-purple-600 transition-colors" title="Toggle AI grading">
              <span class="sr-only">Enable AI grading</span>
              <span id="ai-toggle-dot" class="inline-block h-3.5 w-3.5 transform rounded-full bg-white shadow transition-transform translate-x-5"></span>
            </button>
            <span class="text-xs text-gray-500">+ AI</span>
            <span id="grading-status" class="text-xs text-gray-400 ml-1"></span>
          </div>
          <div id="hint-status" class="flex items-center gap-1">
            <span class="text-yellow-400">‚òÖ</span>
            <span id="potential-star" class="text-yellow-600 font-medium">Gold</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Username Modal -->
  <div id="username-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden relative">
      <!-- Close button (hidden on first visit) -->
      <button id="close-username-modal" class="hidden absolute top-3 right-3 p-2 hover:bg-white/20 rounded-full transition-colors z-10">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <div class="bg-gradient-to-r from-purple-600 to-blue-600 px-6 py-4">
        <h2 id="username-modal-title" class="text-xl font-bold text-white">Welcome!</h2>
        <p id="username-modal-subtitle" class="text-purple-100 text-sm mt-1">Choose a username to track your progress</p>
      </div>
      <div class="p-6">
        <!-- New User Section -->
        <div id="new-user-section">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Your Username</label>
            <div class="flex gap-2">
              <input type="text" id="username-input" class="flex-1 border border-gray-300 rounded-lg p-2.5 text-lg font-medium" readonly>
              <button id="regenerate-username" class="p-2.5 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" title="Generate new username">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
              </button>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Your Name <span class="text-gray-400 font-normal">(optional)</span></label>
            <input type="text" id="realname-input" class="w-full border border-gray-300 rounded-lg p-2" placeholder="First name or nickname">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <input type="password" id="password-input" class="w-full border border-gray-300 rounded-lg p-2" placeholder="Choose a password">
          </div>
        </div>

        <!-- Divider -->
        <div class="flex items-center gap-3 my-4">
          <div class="flex-1 border-t border-gray-200"></div>
          <span class="text-sm text-gray-400">or sign in</span>
          <div class="flex-1 border-t border-gray-200"></div>
        </div>

        <!-- Existing User Section -->
        <div id="existing-user-section">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Existing User</label>
            <select id="existing-user-select" class="w-full border border-gray-300 rounded-lg p-2 bg-white">
              <option value="">Select your username...</option>
            </select>
          </div>
          <div id="existing-password-section" class="mb-4 hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <input type="password" id="existing-password-input" class="w-full border border-gray-300 rounded-lg p-2" placeholder="Enter your password">
          </div>
        </div>

        <button id="username-submit" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-medium py-3 rounded-lg transition-all">
          Let's Go!
        </button>

        <!-- Teacher Login -->
        <div class="mt-4 pt-4 border-t border-gray-200">
          <button id="teacher-login-btn" class="w-full text-sm text-gray-500 hover:text-purple-600 transition-colors">
            I'm a Teacher ‚Üí
          </button>
        </div>

        <!-- Teacher Password Section (hidden by default) -->
        <div id="teacher-password-section" class="hidden mt-4 p-4 bg-purple-50 rounded-lg">
          <label class="block text-sm font-medium text-purple-700 mb-2">Teacher Password</label>
          <input type="password" id="teacher-password-input" class="w-full border border-purple-300 rounded-lg p-2 mb-3" placeholder="Enter teacher password">
          <button id="teacher-submit-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 rounded-lg transition-colors">
            Enter as Teacher
          </button>
        </div>

        <p id="username-error" class="text-red-500 text-sm mt-2 hidden"></p>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Settings</h3>
        <button id="close-settings" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="space-y-4">
        <!-- AI Provider Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Default Grading Mode</label>
          <select id="ai-provider" class="w-full border border-gray-300 rounded-lg p-2">
            <option value="server">Server AI (Recommended)</option>
            <option value="gemini">Google Gemini (Own Key)</option>
            <option value="groq">Groq (Own Key)</option>
            <option value="none">Keyword Matching Only</option>
          </select>
          <p id="server-mode-note" class="text-xs text-green-600 mt-1">No API key needed - grading handled by server.</p>
        </div>

        <!-- API Keys Section -->
        <div id="api-keys-section" class="border-t pt-4 hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">API Keys (for own key modes)</label>
          <a href="https://youtu.be/MyyE05aUAmQ" target="_blank" class="inline-flex items-center gap-1 text-xs text-purple-600 hover:text-purple-800 mb-3">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
            Watch: How to set up API keys
          </a>

          <div class="mb-3">
            <label class="block text-xs text-gray-600 mb-1">
              Gemini Key
              <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-600 hover:underline ml-1">(get free key)</a>
            </label>
            <input type="password" id="gemini-key-input" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="AIza...">
          </div>

          <div>
            <label class="block text-xs text-gray-600 mb-1">
              Groq Key
              <a href="https://console.groq.com/keys" target="_blank" class="text-blue-600 hover:underline ml-1">(get free key)</a>
            </label>
            <input type="password" id="groq-key-input" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="gsk_...">
          </div>

          <p class="text-xs text-gray-400 mt-2">Keys are stored locally in your browser only.</p>
        </div>

        <!-- Sound Effects -->
        <div class="border-t pt-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Sound Effects</label>
          <div class="flex items-center gap-3">
            <button id="sound-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-purple-600 transition-colors">
              <span id="sound-toggle-dot" class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform translate-x-6"></span>
            </button>
            <span id="sound-toggle-label" class="text-sm text-gray-600">Sound effects enabled</span>
          </div>
        </div>

        <!-- Progress Reset -->
        <div class="border-t pt-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Progress</label>
          <button id="reset-progress" class="text-sm text-red-600 hover:text-red-800">Reset All Progress</button>
        </div>
      </div>

      <div class="mt-6 flex justify-end">
        <button id="save-settings" class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded-lg">
          Save Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Leaderboard Panel -->
  <div id="leaderboard-panel" class="fixed inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
    <div class="h-full flex flex-col">
      <div class="bg-gradient-to-r from-yellow-400 to-orange-400 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-2xl">üèÜ</span>
          <h2 class="text-xl font-bold text-white">Class Leaderboard</h2>
        </div>
        <button id="close-leaderboard" class="p-2 hover:bg-white/20 rounded-full transition-colors">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="px-6 py-3 bg-gray-50 border-b flex gap-2">
        <button data-period="today" class="leaderboard-period-btn px-3 py-1 text-sm rounded-full bg-white border border-gray-200 text-gray-600 hover:border-yellow-400">Today</button>
        <button data-period="week" class="leaderboard-period-btn px-3 py-1 text-sm rounded-full bg-white border border-gray-200 text-gray-600 hover:border-yellow-400">This Week</button>
        <button data-period="all" class="leaderboard-period-btn px-3 py-1 text-sm rounded-full bg-yellow-400 text-white border border-yellow-400">All Time</button>
      </div>
      <div id="leaderboard-content" class="flex-1 overflow-y-auto p-4">
        <div id="leaderboard-loading" class="flex items-center justify-center h-32">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-500"></div>
        </div>
        <div id="leaderboard-list" class="space-y-3 hidden"></div>
        <div id="leaderboard-empty" class="text-center text-gray-500 py-8 hidden">
          <span class="text-4xl block mb-2">üìä</span>
          <p>No data yet. Be the first to earn a star!</p>
        </div>
        <div id="leaderboard-offline" class="text-center text-gray-500 py-8 hidden">
          <span class="text-4xl block mb-2">üì°</span>
          <p>Connect to the server to see the leaderboard.</p>
        </div>
      </div>
      <div class="px-6 py-3 bg-gray-50 border-t text-xs text-gray-500">
        <div class="flex items-center gap-4 justify-center">
          <span title="Gold (4 pts)">‚≠ê = 4pts</span>
          <span title="Silver (3 pts)">ü•à = 3pts</span>
          <span title="Bronze (2 pts)">ü•â = 2pts</span>
          <span title="Tin (1 pt)">‚óã = 1pt</span>
        </div>
      </div>
    </div>
  </div>
  <div id="leaderboard-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

  <!-- Teacher Review Panel (Teacher Only) -->
  <div id="teacher-review-panel" class="fixed inset-y-0 right-0 w-full max-w-lg bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
    <div class="h-full flex flex-col">
      <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-2xl">üìù</span>
          <h2 class="text-xl font-bold text-white">Student Reviews</h2>
          <span id="review-count-badge" class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
        </div>
        <button id="close-teacher-review-panel" class="p-2 hover:bg-white/20 rounded-full transition-colors">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="px-6 py-3 bg-gray-50 border-b flex justify-between items-center">
        <div class="flex gap-2">
          <button id="review-filter-pending" class="review-filter-btn px-3 py-1 text-sm rounded-full bg-purple-600 text-white">Pending</button>
          <button id="review-filter-reviewed" class="review-filter-btn px-3 py-1 text-sm rounded-full bg-white border border-gray-200 text-gray-600">Reviewed</button>
        </div>
        <button id="refresh-reviews-btn" class="text-purple-600 hover:text-purple-800 text-sm flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Refresh
        </button>
      </div>
      <div id="teacher-review-content" class="flex-1 overflow-y-auto p-4">
        <div id="teacher-review-loading" class="flex items-center justify-center h-32">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
        </div>
        <div id="teacher-review-list" class="space-y-4 hidden"></div>
        <div id="teacher-review-empty" class="text-center text-gray-500 py-8 hidden">
          <span class="text-4xl block mb-2">‚úÖ</span>
          <p>No pending reviews!</p>
        </div>
      </div>
    </div>
  </div>
  <div id="teacher-review-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

  <!-- Teacher Alert Overlay - Persistent until reviews are cleared -->
  <div id="teacher-alert-overlay" class="fixed inset-0 z-[60] pointer-events-none hidden">
    <!-- Pulsing border effect -->
    <div class="absolute inset-0 border-8 border-red-500 animate-pulse"></div>
    <!-- Alert banner at top -->
    <div class="absolute top-0 left-0 right-0 bg-red-600 text-white py-3 px-4 pointer-events-auto shadow-lg">
      <div class="max-w-6xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-3xl animate-bounce">üîî</span>
          <div>
            <span class="font-bold text-lg">STUDENT NEEDS REVIEW</span>
            <span id="alert-review-count" class="ml-2 bg-white text-red-600 px-2 py-0.5 rounded-full text-sm font-bold">1</span>
          </div>
        </div>
        <button id="alert-open-reviews" class="bg-white text-red-600 hover:bg-red-100 font-bold px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
          <span>Open Reviews</span>
          <span class="text-xl">‚Üí</span>
        </button>
      </div>
    </div>
  </div>

  <style>
    /* Keyframes for alert effects */
    @keyframes alert-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    #teacher-alert-overlay .border-red-500 {
      animation: alert-pulse 1s ease-in-out infinite;
    }
  </style>

  <script type="module">
    import { Platform } from './platform.js';
    import { SoundEngine } from './core/sound-engine.js';
    import { Celebration } from './core/celebration.js';
    import { UserSystem, generateUsername, getAvatarForUsername, getCurrentRank, getRankProgress, getWeightedScore } from './core/user-system.js';
    import { WebSocketClient } from './core/websocket-client.js';
    import { Leaderboard } from './core/leaderboard.js';
    import { ClassTime } from './core/class-time.js';

    // ==================== CONFIGURATION ====================
    const SERVER_URL = 'https://lrsl-driller-production.up.railway.app';

    // ==================== INITIALIZE MODULES ====================
    const soundEngine = new SoundEngine();
    const celebration = new Celebration();
    const userSystem = new UserSystem({ serverUrl: SERVER_URL });
    const leaderboard = new Leaderboard({ serverUrl: SERVER_URL });
    const classTime = new ClassTime();

    const wsClient = new WebSocketClient({
      serverUrl: SERVER_URL,
      onPresenceChange: updateOnlineDisplay,
      onConnectionChange: updateConnectionStatus,
      onClassTimeStart: (goal) => {
        classTime.setGoal(goal);
        classTime.start(false);
        showClassTimeBanner();
      },
      onClassTimeEnd: () => {
        classTime.end(false);
        hideClassTimeBanner();
      },
      onTeacherReviewSubmitted: (message) => {
        // A student submitted work for review - alert the teacher!
        if (isTeacher) {
          showTeacherAlert(message);
        }
      },
      onTeacherReviewCompleted: (message) => {
        // Apply teacher's grades when review is completed for this student
        applyTeacherGrades(message);
      }
    });

    let platform = null;
    let currentCartridgeId = 'lsrl-interpretation';
    let pendingTeacherReview = null; // Store results for teacher review

    // ==================== RESPONSIVE LAYOUT ====================
    function updateMobileLayout() {
      const isMobile = window.innerWidth < 1024; // lg breakpoint
      if (!isMobile) return;

      const header = document.querySelector('header');
      const banner = document.getElementById('class-time-banner');
      const leftPane = document.getElementById('left-pane');

      if (!header || !leftPane) return;

      // Calculate available height
      const headerHeight = header.offsetHeight;
      const bannerHeight = banner && !banner.classList.contains('hidden') ? banner.offsetHeight : 0;
      const availableHeight = window.innerHeight - headerHeight - bannerHeight - 32; // 32px for padding

      // Reserve minimum space for answers (at least 55% of available)
      const maxLeftHeight = Math.min(availableHeight * 0.45, 400);
      leftPane.style.maxHeight = `${maxLeftHeight}px`;
    }

    // Run on load and resize
    window.addEventListener('resize', updateMobileLayout);
    window.addEventListener('orientationchange', () => {
      setTimeout(updateMobileLayout, 100);
    });
    // Initial call after DOM ready
    setTimeout(updateMobileLayout, 0);

    // ==================== UI UPDATES ====================
    function updateStarsDisplay(stars) {
      document.getElementById('gold-count').textContent = stars.gold || 0;
      document.getElementById('silver-count').textContent = stars.silver || 0;
      document.getElementById('bronze-count').textContent = stars.bronze || 0;
      document.getElementById('tin-count').textContent = stars.tin || 0;
    }

    function updateStreaksDisplay(streaks) {
      const container = document.getElementById('streaks-display');
      container.innerHTML = '';
      for (const [field, count] of Object.entries(streaks)) {
        const el = document.createElement('div');
        el.className = 'flex items-center gap-1';
        el.innerHTML = `<span class="text-gray-500">${capitalize(field)}:</span><span class="font-bold text-purple-600">${count}</span>`;
        container.appendChild(el);
      }
    }

    function updateRankDisplay(stars) {
      const rank = getCurrentRank(stars);
      const progress = getRankProgress(stars);
      const points = getWeightedScore(stars);

      document.getElementById('rank-icon').textContent = rank.icon;
      document.getElementById('rank-name').textContent = rank.name;
      document.getElementById('rank-progress-bar').style.width = `${progress}%`;
      document.getElementById('rank-points').textContent = `${points} pts`;
    }

    function updateOnlineDisplay(users) {
      document.getElementById('online-count').textContent = users.length;
      const list = document.getElementById('online-list');
      if (users.length === 0) {
        list.innerHTML = '<div class="px-3 py-2 text-sm text-gray-400 italic">No one else online</div>';
      } else {
        list.innerHTML = users.map(username => {
          const isYou = username === userSystem.currentUser?.username;
          const avatar = getAvatarForUsername(username);
          return `
            <div class="px-3 py-1.5 flex items-center gap-2 ${isYou ? 'bg-purple-50' : 'hover:bg-gray-50'}">
              <span class="text-lg">${avatar}</span>
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-sm text-gray-700">${username}</span>
              ${isYou ? '<span class="text-xs text-purple-600 ml-auto">(you)</span>' : ''}
            </div>
          `;
        }).join('');
      }
    }

    function updateConnectionStatus(connected) {
      const dot = document.getElementById('connection-dot');
      if (connected) {
        dot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
      } else {
        dot.className = 'w-2 h-2 bg-gray-400 rounded-full';
      }
    }

    function updatePotentialStar(hintsUsed) {
      const tiers = ['Gold', 'Silver', 'Bronze', 'Tin', 'Tin'];
      document.getElementById('potential-star').textContent = tiers[Math.min(hintsUsed, 4)];
    }

    function showClassTimeBanner() {
      document.getElementById('class-time-banner').classList.remove('hidden');
    }

    function hideClassTimeBanner() {
      document.getElementById('class-time-banner').classList.add('hidden');
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // ==================== GRADING STATUS ====================
    function updateGradingStatus(results) {
      const statusEl = document.getElementById('grading-status');
      if (!statusEl) return;

      switch (results._gradingMethod) {
        case 'keywords':
          statusEl.textContent = '(keywords)';
          statusEl.className = 'text-xs text-gray-400 ml-1';
          break;
        case 'keywords+ai':
          statusEl.textContent = '(keywords + AI)';
          statusEl.className = 'text-xs text-green-600 ml-1';
          break;
        case 'keywords+teacher-review':
          statusEl.textContent = '(keywords + teacher review available)';
          statusEl.className = 'text-xs text-orange-500 ml-1';
          break;
        default:
          statusEl.textContent = '';
      }
    }

    /**
     * Apply teacher's grades when WebSocket notification received
     */
    async function applyTeacherGrades(message) {
      console.log('Applying teacher grades:', message);

      // Only apply if this is for the current user
      if (message.username !== userSystem.currentUser?.username) {
        console.log('Not for current user, skipping');
        return;
      }

      const grades = message.grades;
      console.log('Grades received:', grades);
      if (!grades) {
        console.warn('No grades in teacher review message');
        return;
      }

      // Build results object similar to what grading produces
      const results = {
        fields: {},
        allCorrect: true,
        _gradingMethod: 'teacher-review'
      };

      for (const [fieldId, score] of Object.entries(grades)) {
        results.fields[fieldId] = {
          score: score,
          feedback: `Teacher grade: ${score}`,
          _method: 'teacher'
        };
        if (score !== 'E') {
          results.allCorrect = false;
        }
      }

      console.log('Results built:', results);
      console.log('allCorrect:', results.allCorrect);

      // Update the UI with teacher's grades
      platform.inputRenderer?.showAllFeedback(results);

      // Record results in game engine
      for (const [fieldId, result] of Object.entries(results.fields)) {
        platform.gameEngine.recordResult(fieldId, result.score, results.allCorrect);
      }

      // Clear teacher review button and pending data
      clearTeacherReview();

      // Handle star earning if all correct
      if (results.allCorrect) {
        const state = platform.getState();
        const hintsUsed = state.game.hintsUsed || 0;
        const starType = ['gold', 'silver', 'bronze', 'tin'][Math.min(hintsUsed, 3)];

        // Play sounds and show celebration
        soundEngine.init();
        soundEngine.correct();
        soundEngine.starSound(starType);

        if (starType === 'gold') {
          celebration.triggerConfetti();
        }
        celebration.showStarEarned(starType);

        // Update displays
        const newState = platform.getState();
        updateStarsDisplay(newState.game.starCounts);
        updateStreaksDisplay(newState.game.streaks);
        updateRankDisplay(newState.game.starCounts);
        updatePotentialStar(0);

        // Show Next button - MUST remove hidden class first (Tailwind uses !important)
        const btnGrade = document.getElementById('btn-grade');
        const btnTryAgain = document.getElementById('btn-try-again');
        const btnNext = document.getElementById('btn-next');

        btnGrade.classList.add('hidden');
        btnTryAgain.classList.add('hidden');
        btnNext.classList.remove('hidden');

        console.log('Teacher grades applied - showing Next button');
        console.log('btn-next classList:', btnNext.classList.toString());

        celebration.showToast('Your teacher gave you all E\'s! ‚≠ê', 'success', 5000);
      } else {
        // Not all correct - show try again
        const btnGrade = document.getElementById('btn-grade');
        const btnTryAgain = document.getElementById('btn-try-again');
        const btnNext = document.getElementById('btn-next');

        btnGrade.classList.add('hidden');
        btnNext.classList.add('hidden');
        btnTryAgain.classList.remove('hidden');

        console.log('Teacher grades applied - showing Try Again button');

        celebration.showToast('Teacher reviewed your work. Check the feedback!', 'info', 5000);
      }
    }

    function showTeacherReviewOption(results, message) {
      // Store for later submission
      pendingTeacherReview = {
        results,
        problem: platform.currentProblem,
        answers: platform.inputRenderer?.getAllValues(),
        timestamp: new Date().toISOString(),
        username: userSystem.currentUser?.username
      };

      // Show teacher review button
      const reviewBtn = document.getElementById('btn-teacher-review');
      if (reviewBtn) {
        reviewBtn.classList.remove('hidden');
      }

      // Show info toast with custom message
      celebration.showToast(message || 'Teacher review available.', 'info', 5000);
    }

    async function submitForTeacherReview() {
      console.log('submitForTeacherReview called, pendingTeacherReview:', pendingTeacherReview);
      if (!pendingTeacherReview) {
        console.log('No pending review to submit');
        return;
      }

      try {
        // Send to server for teacher review queue
        const response = await fetch(`${SERVER_URL}/api/teacher-review`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(pendingTeacherReview)
        });

        if (response.ok) {
          celebration.showToast('Submitted for teacher review!', 'success');
          document.getElementById('btn-teacher-review')?.classList.add('hidden');
          pendingTeacherReview = null;
        } else {
          throw new Error('Failed to submit');
        }
      } catch (err) {
        console.error('Teacher review submission failed:', err);
        celebration.showToast('Could not submit for review. Try again later.', 'error');
      }
    }

    // ==================== USERNAME MODAL ====================
    const usernameModal = {
      isFirstVisit: true,

      async show(isFirstVisit = false) {
        this.isFirstVisit = isFirstVisit;
        document.getElementById('username-modal').classList.remove('hidden');
        document.getElementById('username-input').value = generateUsername();
        document.getElementById('username-error').classList.add('hidden');

        // Show/hide close button based on first visit
        const closeBtn = document.getElementById('close-username-modal');
        if (isFirstVisit) {
          closeBtn.classList.add('hidden');
        } else {
          closeBtn.classList.remove('hidden');
        }

        // Populate existing users dropdown
        await this.populateExistingUsers();
      },

      hide() {
        document.getElementById('username-modal').classList.add('hidden');
      },

      async populateExistingUsers() {
        const select = document.getElementById('existing-user-select');
        select.innerHTML = '<option value="">Select your username...</option>';

        try {
          const users = await userSystem.getUsers();
          for (const user of users) {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = user.real_name
              ? `${user.username} (${user.real_name})`
              : user.username;
            select.appendChild(option);
          }
        } catch (err) {
          console.warn('Could not load existing users:', err);
        }
      },

      async submit() {
        const existingSelect = document.getElementById('existing-user-select');
        const existingPassword = document.getElementById('existing-password-input');

        // Check if logging in as existing user
        if (existingSelect.value) {
          const result = await userSystem.verifyUser(existingSelect.value, existingPassword.value);
          if (result.error) {
            document.getElementById('username-error').textContent = result.error;
            document.getElementById('username-error').classList.remove('hidden');
            return;
          }

          document.getElementById('current-username').textContent = existingSelect.value;
          wsClient.connect(existingSelect.value);
          leaderboard.setCurrentUser(existingSelect.value);
          this.hide();
          soundEngine.init();
          loadCartridge(currentCartridgeId);
          return;
        }

        // New user registration
        const username = document.getElementById('username-input').value.trim();
        const realName = document.getElementById('realname-input').value.trim();
        const password = document.getElementById('password-input').value;

        if (!username || !password) {
          document.getElementById('username-error').textContent = 'Username and password required';
          document.getElementById('username-error').classList.remove('hidden');
          return;
        }

        const result = await userSystem.createUser(username, realName, password);
        if (result.error) {
          document.getElementById('username-error').textContent = result.error;
          document.getElementById('username-error').classList.remove('hidden');
          return;
        }

        document.getElementById('current-username').textContent = username;
        wsClient.connect(username);
        leaderboard.setCurrentUser(username);
        this.hide();
        soundEngine.init();

        // Load first problem
        loadCartridge(currentCartridgeId);
      }
    };

    // Existing user dropdown - show password field when selected
    document.getElementById('existing-user-select').addEventListener('change', (e) => {
      const passwordSection = document.getElementById('existing-password-section');
      if (e.target.value) {
        passwordSection.classList.remove('hidden');
      } else {
        passwordSection.classList.add('hidden');
      }
    });

    document.getElementById('regenerate-username').addEventListener('click', () => {
      document.getElementById('username-input').value = generateUsername();
    });

    document.getElementById('username-submit').addEventListener('click', () => usernameModal.submit());

    document.getElementById('close-username-modal').addEventListener('click', () => usernameModal.hide());

    document.getElementById('user-display').addEventListener('click', () => usernameModal.show(false));

    // ==================== GLOBAL ESCAPE KEY HANDLER ====================
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close username modal (if not first visit)
        const usernameModalEl = document.getElementById('username-modal');
        if (!usernameModalEl.classList.contains('hidden') && !usernameModal.isFirstVisit) {
          usernameModal.hide();
          return;
        }

        // Close settings modal
        const settingsModal = document.getElementById('settings-modal');
        if (!settingsModal.classList.contains('hidden')) {
          settingsModal.classList.add('hidden');
          return;
        }

        // Close leaderboard panel
        const leaderboardPanel = document.getElementById('leaderboard-panel');
        if (!leaderboardPanel.classList.contains('translate-x-full')) {
          leaderboard.close();
          return;
        }
      }
    });

    // ==================== SETTINGS MODAL ====================
    document.getElementById('settings-btn').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('hidden');
    });

    document.getElementById('close-settings').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.add('hidden');
    });

    document.getElementById('sound-toggle').addEventListener('click', () => {
      soundEngine.setEnabled(!soundEngine.enabled);
      const dot = document.getElementById('sound-toggle-dot');
      const label = document.getElementById('sound-toggle-label');
      dot.classList.toggle('translate-x-6', soundEngine.enabled);
      dot.classList.toggle('translate-x-1', !soundEngine.enabled);
      label.textContent = soundEngine.enabled ? 'Sound effects enabled' : 'Sound effects disabled';
    });

    // AI Provider dropdown - show/hide API keys section
    document.getElementById('ai-provider').addEventListener('change', (e) => {
      const keysSection = document.getElementById('api-keys-section');
      const serverNote = document.getElementById('server-mode-note');

      if (e.target.value === 'gemini' || e.target.value === 'groq') {
        keysSection.classList.remove('hidden');
        serverNote.classList.add('hidden');
      } else {
        keysSection.classList.add('hidden');
        serverNote.classList.remove('hidden');
      }
    });

    // Save settings
    document.getElementById('save-settings').addEventListener('click', () => {
      const provider = document.getElementById('ai-provider').value;
      const geminiKey = document.getElementById('gemini-key-input').value;
      const groqKey = document.getElementById('groq-key-input').value;

      // Save to localStorage
      localStorage.setItem('aiProvider', provider);
      if (geminiKey) localStorage.setItem('geminiApiKey', geminiKey);
      if (groqKey) localStorage.setItem('groqApiKey', groqKey);

      // Update AI toggle state based on provider
      updateAIToggleState(provider !== 'none');

      document.getElementById('settings-modal').classList.add('hidden');
      celebration.showToast('Settings saved!', 'success');
    });

    // Load settings on page load
    function loadSettings() {
      const provider = localStorage.getItem('aiProvider') || 'server';
      const geminiKey = localStorage.getItem('geminiApiKey') || '';
      const groqKey = localStorage.getItem('groqApiKey') || '';

      document.getElementById('ai-provider').value = provider;
      document.getElementById('gemini-key-input').value = geminiKey;
      document.getElementById('groq-key-input').value = groqKey;

      // Show API keys section if using own key
      if (provider === 'gemini' || provider === 'groq') {
        document.getElementById('api-keys-section').classList.remove('hidden');
        document.getElementById('server-mode-note').classList.add('hidden');
      }

      // Set initial AI toggle state
      updateAIToggleState(provider !== 'none');
    }

    // ==================== AI TOGGLE ====================
    let aiEnabled = true;

    function updateAIToggleState(enabled) {
      aiEnabled = enabled;
      const toggle = document.getElementById('ai-toggle');
      const dot = document.getElementById('ai-toggle-dot');
      const status = document.getElementById('grading-status');

      if (enabled) {
        toggle.classList.remove('bg-gray-400');
        toggle.classList.add('bg-purple-600');
        dot.classList.remove('translate-x-1');
        dot.classList.add('translate-x-5');
        status.textContent = '';
      } else {
        toggle.classList.add('bg-gray-400');
        toggle.classList.remove('bg-purple-600');
        dot.classList.add('translate-x-1');
        dot.classList.remove('translate-x-5');
        status.textContent = '(keywords only)';
      }
    }

    document.getElementById('ai-toggle').addEventListener('click', () => {
      updateAIToggleState(!aiEnabled);
      localStorage.setItem('aiProvider', aiEnabled ? 'server' : 'none');
    });

    // ==================== TEACHER LOGIN ====================
    let isTeacher = false;

    document.getElementById('teacher-login-btn').addEventListener('click', () => {
      document.getElementById('teacher-password-section').classList.toggle('hidden');
    });

    document.getElementById('teacher-submit-btn').addEventListener('click', async () => {
      const password = document.getElementById('teacher-password-input').value;

      // Simple teacher password check (in production, verify server-side)
      if (password === 'stats123' || password === 'teacher123') { // Accept both passwords
        console.log('Teacher login successful');
        isTeacher = true;
        teacherPassword = password; // Store for API calls
        document.getElementById('teacher-badge').classList.remove('hidden');

        const classTimeBtn = document.getElementById('class-time-btn');
        const reviewBtn = document.getElementById('teacher-review-btn');
        console.log('class-time-btn element:', classTimeBtn);
        console.log('teacher-review-btn element:', reviewBtn);

        if (classTimeBtn) classTimeBtn.style.display = 'flex';
        if (reviewBtn) reviewBtn.style.display = 'flex';

        usernameModal.hide();
        celebration.showToast('Welcome, Teacher!', 'success');
        soundEngine.init();
        loadCartridge(currentCartridgeId);
        // Load pending reviews
        loadPendingReviews();
      } else {
        document.getElementById('username-error').textContent = 'Invalid teacher password';
        document.getElementById('username-error').classList.remove('hidden');
      }
    });

    // Class Time button (teacher only)
    document.getElementById('class-time-btn').addEventListener('click', () => {
      if (!classTime.isActive()) {
        const goal = prompt('How many stars should students earn?', '3');
        if (goal && !isNaN(goal)) {
          classTime.setGoal(parseInt(goal));
          classTime.start(true);
          showClassTimeBanner();
          document.getElementById('end-class-time-btn').classList.remove('hidden');
        }
      }
    });

    document.getElementById('end-class-time-btn').addEventListener('click', () => {
      classTime.end(true);
      hideClassTimeBanner();
    });

    // ==================== LEADERBOARD ====================
    leaderboard.setElements({
      panel: document.getElementById('leaderboard-panel'),
      backdrop: document.getElementById('leaderboard-backdrop'),
      list: document.getElementById('leaderboard-list'),
      loading: document.getElementById('leaderboard-loading'),
      empty: document.getElementById('leaderboard-empty'),
      offline: document.getElementById('leaderboard-offline')
    });

    document.getElementById('leaderboard-btn').addEventListener('click', () => leaderboard.open());
    document.getElementById('close-leaderboard').addEventListener('click', () => leaderboard.close());
    document.getElementById('leaderboard-backdrop').addEventListener('click', () => leaderboard.close());

    document.querySelectorAll('.leaderboard-period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.leaderboard-period-btn').forEach(b => {
          b.className = 'leaderboard-period-btn px-3 py-1 text-sm rounded-full bg-white border border-gray-200 text-gray-600 hover:border-yellow-400';
        });
        btn.className = 'leaderboard-period-btn px-3 py-1 text-sm rounded-full bg-yellow-400 text-white border border-yellow-400';
        leaderboard.setPeriod(btn.dataset.period);
      });
    });

    // ==================== ONLINE DROPDOWN ====================
    document.getElementById('online-btn').addEventListener('click', () => {
      document.getElementById('online-dropdown').classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('#online-indicator')) {
        document.getElementById('online-dropdown').classList.add('hidden');
      }
    });

    // ==================== TEACHER REVIEW PANEL ====================
    let currentReviewFilter = 'pending';
    let pendingReviewsCache = [];
    let teacherPassword = null; // Store the password used to login
    let teacherAlertActive = false; // Track if alert overlay is showing

    function openTeacherReviewPanel() {
      document.getElementById('teacher-review-panel').classList.remove('translate-x-full');
      document.getElementById('teacher-review-backdrop').classList.remove('hidden');
      loadPendingReviews();
    }

    function closeTeacherReviewPanel() {
      document.getElementById('teacher-review-panel').classList.add('translate-x-full');
      document.getElementById('teacher-review-backdrop').classList.add('hidden');
    }

    async function loadPendingReviews() {
      console.log('loadPendingReviews called, filter:', currentReviewFilter);
      const loading = document.getElementById('teacher-review-loading');
      const list = document.getElementById('teacher-review-list');
      const empty = document.getElementById('teacher-review-empty');

      loading.classList.remove('hidden');
      list.classList.add('hidden');
      empty.classList.add('hidden');

      try {
        const url = `${SERVER_URL}/api/teacher-review?status=${currentReviewFilter}`;
        console.log('Fetching reviews from:', url, 'with password:', teacherPassword);
        const response = await fetch(url, {
          headers: { 'x-teacher-password': teacherPassword || 'stats123' }
        });

        console.log('Response status:', response.status);
        if (!response.ok) throw new Error('Failed to fetch reviews: ' + response.status);

        const reviews = await response.json();
        console.log('Reviews fetched:', reviews);
        pendingReviewsCache = reviews;

        loading.classList.add('hidden');

        if (reviews.length === 0) {
          empty.classList.remove('hidden');
          empty.querySelector('p').textContent = currentReviewFilter === 'pending'
            ? 'No pending reviews!'
            : 'No reviewed items yet.';
        } else {
          list.classList.remove('hidden');
          renderReviewList(reviews);
        }

        // Update badge counts and alert
        if (currentReviewFilter === 'pending') {
          updateReviewBadge(reviews.length);
          // Show alert overlay if there are pending reviews
          if (reviews.length > 0 && isTeacher) {
            const overlay = document.getElementById('teacher-alert-overlay');
            if (overlay && overlay.classList.contains('hidden')) {
              overlay.classList.remove('hidden');
              teacherAlertActive = true;
              document.getElementById('alert-review-count').textContent = reviews.length;
            }
          }
        }
      } catch (err) {
        console.error('Failed to load reviews:', err);
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
        empty.querySelector('p').textContent = 'Failed to load reviews.';
      }
    }

    function updateReviewBadge(count) {
      const headerBadge = document.getElementById('header-review-count');
      const panelBadge = document.getElementById('review-count-badge');
      const alertCount = document.getElementById('alert-review-count');

      if (count > 0) {
        headerBadge.textContent = count;
        headerBadge.style.display = 'inline';
        panelBadge.textContent = count;
        panelBadge.classList.remove('hidden');
        if (alertCount) alertCount.textContent = count;
      } else {
        headerBadge.style.display = 'none';
        panelBadge.classList.add('hidden');
        // Hide alert overlay when no pending reviews
        hideTeacherAlert();
      }
    }

    // ==================== TEACHER ALERT SYSTEM ====================
    function showTeacherAlert(message) {
      const overlay = document.getElementById('teacher-alert-overlay');
      if (!overlay) return;

      // Show the overlay
      overlay.classList.remove('hidden');
      teacherAlertActive = true;

      // Update count
      const alertCount = document.getElementById('alert-review-count');
      if (alertCount) {
        const currentCount = parseInt(alertCount.textContent) || 0;
        alertCount.textContent = currentCount + 1;
      }

      // Play urgent bell sound
      soundEngine.init();
      soundEngine.teacherAlert();

      // Refresh the reviews list to get the new one
      loadPendingReviews();

      console.log('Teacher alert shown for:', message?.username, message?.topic);
    }

    function hideTeacherAlert() {
      const overlay = document.getElementById('teacher-alert-overlay');
      if (overlay) {
        overlay.classList.add('hidden');
      }
      teacherAlertActive = false;
    }

    // Alert overlay button - opens the review panel
    document.getElementById('alert-open-reviews')?.addEventListener('click', () => {
      openTeacherReviewPanel();
    });

    function renderReviewList(reviews) {
      const list = document.getElementById('teacher-review-list');
      list.innerHTML = reviews.map(review => {
        const answers = review.student_answers || {};
        const context = review.scenario_context || {};
        const keywordResults = review.keyword_results || {};
        const teacherGrades = review.teacher_grades || {};
        const isReviewed = review.status === 'reviewed';

        return `
          <div class="bg-white border rounded-lg shadow-sm p-4" data-review-id="${review.id}">
            <div class="flex justify-between items-start mb-3">
              <div>
                <span class="font-semibold text-gray-800">${review.username}</span>
                <span class="text-gray-500 text-sm ml-2">${review.scenario_topic}</span>
              </div>
              <span class="text-xs text-gray-400">${new Date(review.submitted_at).toLocaleString()}</span>
            </div>

            <div class="text-sm text-gray-600 mb-3">
              <div><strong>x:</strong> ${context.xVar || '?'} (${context.xUnits || '?'})</div>
              <div><strong>y:</strong> ${context.yVar || '?'} (${context.yUnits || '?'})</div>
              <div><strong>Equation:</strong> ≈∑ = ${context.intercept || '?'} + ${context.slope || '?'}x</div>
              <div><strong>r:</strong> ${context.r || '?'}</div>
            </div>

            <div class="space-y-3">
              ${['slope', 'intercept', 'correlation'].map(field => `
                <div class="border-l-4 ${getGradeBorderColor(isReviewed ? teacherGrades[field] : keywordResults[field]?.score)} pl-3">
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-700 capitalize">${field}</span>
                    ${isReviewed
                      ? `<span class="font-bold ${getGradeTextColor(teacherGrades[field])}">${teacherGrades[field] || '?'}</span>`
                      : `<div class="flex gap-1">
                          <button onclick="setReviewGrade('${review.id}', '${field}', 'E')" class="grade-btn px-2 py-0.5 text-xs rounded ${teacherGrades[field] === 'E' ? 'bg-green-500 text-white' : 'bg-gray-100 hover:bg-green-100'}">E</button>
                          <button onclick="setReviewGrade('${review.id}', '${field}', 'P')" class="grade-btn px-2 py-0.5 text-xs rounded ${teacherGrades[field] === 'P' ? 'bg-yellow-500 text-white' : 'bg-gray-100 hover:bg-yellow-100'}">P</button>
                          <button onclick="setReviewGrade('${review.id}', '${field}', 'I')" class="grade-btn px-2 py-0.5 text-xs rounded ${teacherGrades[field] === 'I' ? 'bg-red-500 text-white' : 'bg-gray-100 hover:bg-red-100'}">I</button>
                        </div>`
                    }
                  </div>
                  <p class="text-sm text-gray-600 mt-1 italic">"${answers[field] || '(empty)'}"</p>
                  ${keywordResults[field]?.feedback ? `<p class="text-xs text-gray-400 mt-1">Keywords: ${keywordResults[field].score} - ${keywordResults[field].feedback}</p>` : ''}
                </div>
              `).join('')}
            </div>

            ${!isReviewed ? `
              <div class="mt-4 flex justify-end">
                <button onclick="submitTeacherGrades('${review.id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                  Submit Grades
                </button>
              </div>
            ` : `
              <div class="mt-3 text-xs text-green-600 text-right">
                ‚úì Reviewed ${review.reviewed_at ? new Date(review.reviewed_at).toLocaleString() : ''}
              </div>
            `}
          </div>
        `;
      }).join('');
    }

    function getGradeBorderColor(grade) {
      switch(grade) {
        case 'E': return 'border-green-500';
        case 'P': return 'border-yellow-500';
        case 'I': return 'border-red-500';
        default: return 'border-gray-300';
      }
    }

    function getGradeTextColor(grade) {
      switch(grade) {
        case 'E': return 'text-green-600';
        case 'P': return 'text-yellow-600';
        case 'I': return 'text-red-600';
        default: return 'text-gray-400';
      }
    }

    // Store pending grades for each review
    const pendingGrades = {};

    window.setReviewGrade = function(reviewId, field, grade) {
      if (!pendingGrades[reviewId]) {
        pendingGrades[reviewId] = {};
      }
      pendingGrades[reviewId][field] = grade;

      // Update button styling
      const reviewEl = document.querySelector(`[data-review-id="${reviewId}"]`);
      if (reviewEl) {
        const fieldEl = reviewEl.querySelectorAll('.border-l-4')[['slope', 'intercept', 'correlation'].indexOf(field)];
        if (fieldEl) {
          fieldEl.querySelectorAll('.grade-btn').forEach(btn => {
            const btnGrade = btn.textContent;
            btn.className = `grade-btn px-2 py-0.5 text-xs rounded ${btnGrade === grade
              ? (grade === 'E' ? 'bg-green-500 text-white' : grade === 'P' ? 'bg-yellow-500 text-white' : 'bg-red-500 text-white')
              : 'bg-gray-100 hover:bg-gray-200'}`;
          });
        }
      }
    };

    window.submitTeacherGrades = async function(reviewId) {
      const grades = pendingGrades[reviewId];
      if (!grades || !grades.slope || !grades.intercept || !grades.correlation) {
        celebration.showToast('Please grade all three fields', 'warning');
        return;
      }

      try {
        const response = await fetch(`${SERVER_URL}/api/teacher-review/${reviewId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-teacher-password': teacherPassword || 'stats123'
          },
          body: JSON.stringify({ grades })
        });

        if (!response.ok) throw new Error('Failed to submit grades');

        celebration.showToast('Grades submitted!', 'success');
        delete pendingGrades[reviewId];
        loadPendingReviews();
      } catch (err) {
        console.error('Failed to submit grades:', err);
        celebration.showToast('Failed to submit grades', 'error');
      }
    };

    // Teacher review panel event listeners
    document.getElementById('teacher-review-btn')?.addEventListener('click', openTeacherReviewPanel);
    document.getElementById('close-teacher-review-panel')?.addEventListener('click', closeTeacherReviewPanel);
    document.getElementById('teacher-review-backdrop')?.addEventListener('click', closeTeacherReviewPanel);
    document.getElementById('refresh-reviews-btn')?.addEventListener('click', loadPendingReviews);

    document.getElementById('review-filter-pending')?.addEventListener('click', () => {
      currentReviewFilter = 'pending';
      document.getElementById('review-filter-pending').className = 'review-filter-btn px-3 py-1 text-sm rounded-full bg-purple-600 text-white';
      document.getElementById('review-filter-reviewed').className = 'review-filter-btn px-3 py-1 text-sm rounded-full bg-white border border-gray-200 text-gray-600';
      loadPendingReviews();
    });

    document.getElementById('review-filter-reviewed')?.addEventListener('click', () => {
      currentReviewFilter = 'reviewed';
      document.getElementById('review-filter-reviewed').className = 'review-filter-btn px-3 py-1 text-sm rounded-full bg-purple-600 text-white';
      document.getElementById('review-filter-pending').className = 'review-filter-btn px-3 py-1 text-sm rounded-full bg-white border border-gray-200 text-gray-600';
      loadPendingReviews();
    });

    // ==================== CLASS TIME ====================
    classTime.onTimerUpdate = (time) => {
      document.getElementById('class-time-timer').textContent = time;
    };

    classTime.onStarEarned = ({ total, goal, progress }) => {
      document.getElementById('class-stars-earned').textContent = total;
      document.getElementById('class-goal-bar').style.width = `${progress}%`;
    };

    // ==================== LOAD CARTRIDGE ====================
    async function loadCartridge(cartridgeId) {
      try {
        platform = new Platform({
          graphContainer: '#graph-container',
          inputsContainer: '#input-container',
          infoContainer: '#info-panel',
          cartridgesPath: '../cartridges',
          sharedPath: '../shared',
          onStateChange: (state) => {
            if (state.game) {
              updateStarsDisplay(state.game.starCounts);
              updateStreaksDisplay(state.game.streaks);
              updateRankDisplay(state.game.starCounts);
              updatePotentialStar(state.game.hintsUsed || 0);
            }
          },
          onGradingComplete: (results) => {
            // Log grading info
            console.log('Grading complete:', results);
            console.log(`  Method: ${results._gradingMethod}`);
            for (const [fieldId, result] of Object.entries(results.fields || {})) {
              const method = result._method || 'keywords';
              const aiInfo = result._aiScore ? ` (AI: ${result._aiScore})` : '';
              console.log(`  ${fieldId}: ${result.score} via ${method}${aiInfo}`);
            }

            // Update grading status display
            updateGradingStatus(results);

            // Handle teacher review - available whenever student might want a second opinion
            if (results._aiFailed && results._gradingMethod === 'keywords+teacher-review') {
              showTeacherReviewOption(results, 'AI grading unavailable. Your work can be submitted for teacher review.');
            } else if (results._aiGradedLower) {
              // Check if it's because of incomplete AI feedback
              const hasIncomplete = Object.values(results.fields || {}).some(f => f._aiIncomplete);
              if (hasIncomplete) {
                showTeacherReviewOption(results, 'AI feedback was limited. Request teacher review for detailed feedback.');
              } else {
                showTeacherReviewOption(results, 'AI and keywords disagree on some answers. Request teacher review if needed.');
              }
            } else if (!results.allCorrect) {
              // Always offer teacher review when student got something wrong - they may want to appeal
              showTeacherReviewOption(results, 'Think your answer deserves a better grade? Request teacher review.');
            }

            if (results.allCorrect) {
              const state = platform.getState();
              const starType = ['gold', 'silver', 'bronze', 'tin'][Math.min(state.game.hintsUsed || 0, 3)];

              soundEngine.init();
              soundEngine.starSound(starType);
              celebration.celebrate(starType);

              // Notify server
              if (wsClient.isConnected() && userSystem.currentUser) {
                wsClient.notifyStarEarned(
                  userSystem.currentUser.username,
                  starType,
                  state.currentProblem?.context?.topic || 'Practice'
                );
              }

              // Record for class time
              if (classTime.isActive()) {
                classTime.recordStar(starType);
              }

              document.getElementById('btn-grade').classList.add('hidden');
              document.getElementById('btn-next').classList.remove('hidden');
            } else {
              document.getElementById('btn-grade').classList.add('hidden');
              document.getElementById('btn-try-again').classList.remove('hidden');
            }
          }
        });

        platform.init();
        await platform.loadCartridge(cartridgeId);

        document.getElementById('app-title').textContent = platform.currentCartridge?.manifest?.meta?.name || 'Driller';

        // Update mode tabs
        const modes = platform.currentCartridge?.manifest?.modes || [];
        const tabsContainer = document.getElementById('mode-tabs');
        tabsContainer.innerHTML = '';
        const gameState = platform.gameEngine.getState();

        modes.forEach((mode, i) => {
          // Check if mode is unlocked
          const isUnlocked = mode.unlockedBy === 'default' ||
            gameState.unlockedTiers.includes(mode.id) ||
            (mode.unlockedBy?.gold && gameState.starCounts.gold >= mode.unlockedBy.gold);

          const btn = document.createElement('button');
          btn.dataset.modeId = mode.id;

          if (isUnlocked) {
            btn.textContent = mode.name;
            btn.className = i === 0
              ? 'px-4 py-2 rounded-lg bg-purple-600 text-white font-medium'
              : 'px-4 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200';
            btn.addEventListener('click', () => {
              tabsContainer.querySelectorAll('button').forEach(b => {
                if (!b.disabled) {
                  b.className = 'px-4 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200';
                }
              });
              btn.className = 'px-4 py-2 rounded-lg bg-purple-600 text-white font-medium';
              platform.setMode(mode.id);
              platform.loadProblem();
            });
          } else {
            // Locked mode
            const requirement = mode.unlockedBy?.gold ? `${mode.unlockedBy.gold} gold ‚òÖ` : 'locked';
            btn.textContent = `üîí ${mode.name}`;
            btn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-400 cursor-not-allowed';
            btn.disabled = true;
            btn.title = `Requires ${requirement} to unlock`;
          }

          tabsContainer.appendChild(btn);
        });

        await platform.loadProblem();
        updateScenarioDisplay();

        currentCartridgeId = cartridgeId;

      } catch (err) {
        console.error('Failed to load cartridge:', err);
      }
    }

    function updateScenarioDisplay() {
      const problem = platform.currentProblem;
      if (!problem) return;

      document.getElementById('scenario-title').textContent = problem.context?.topic || 'Practice Problem';
      document.getElementById('scenario-text').textContent = problem.scenario || '';
    }

    // ==================== ACTION BUTTONS ====================
    document.getElementById('btn-grade').addEventListener('click', async () => {
      soundEngine.init();
      // Pass AI enabled state to grading
      await platform.grade({ useAI: aiEnabled });
    });

    document.getElementById('btn-try-again').addEventListener('click', () => {
      document.getElementById('btn-try-again').classList.add('hidden');
      document.getElementById('btn-grade').classList.remove('hidden');
      // Clear feedback and re-enable inputs
      platform.inputRenderer?.clearAllFeedback();
      platform.inputRenderer?.enable();
      clearTeacherReview();
    });

    document.getElementById('btn-next').addEventListener('click', async () => {
      // Reset button visibility - show Grade, hide others (use classList for Tailwind)
      document.getElementById('btn-next').classList.add('hidden');
      document.getElementById('btn-try-again').classList.add('hidden');
      document.getElementById('btn-grade').classList.remove('hidden');
      // Clear any leftover feedback before loading new problem
      platform.inputRenderer?.clearAllFeedback();
      await platform.loadProblem();
      updateScenarioDisplay();
      clearTeacherReview();
    });

    document.getElementById('btn-skip').addEventListener('click', async () => {
      platform.inputRenderer?.clearAllFeedback();
      await platform.loadProblem();
      updateScenarioDisplay();
      clearTeacherReview();
    });

    document.getElementById('btn-teacher-review').addEventListener('click', submitForTeacherReview);

    function clearTeacherReview() {
      pendingTeacherReview = null;
      document.getElementById('btn-teacher-review')?.classList.add('hidden');
      document.getElementById('grading-status').textContent = '';
    }

    document.getElementById('cartridge-select').addEventListener('change', (e) => {
      loadCartridge(e.target.value);
    });

    // ==================== INIT ====================
    async function init() {
      // Load settings first
      loadSettings();

      await userSystem.init();

      if (userSystem.currentUser) {
        document.getElementById('current-username').textContent = userSystem.currentUser.username;
        wsClient.connect(userSystem.currentUser.username);
        leaderboard.setCurrentUser(userSystem.currentUser.username);
        loadCartridge(currentCartridgeId);
      } else {
        usernameModal.show(true); // First visit - cannot close modal
      }
    }

    init();
  </script>
</body>
</html>
